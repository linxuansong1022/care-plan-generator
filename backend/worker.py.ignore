# worker.py

import os
import django


# ---- ç¬¬ 1 ä»¶äº‹ï¼šåˆå§‹åŒ– Django ç¯å¢ƒ ----
# ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªï¼Ÿå› ä¸º worker.py æ˜¯ç‹¬ç«‹è„šæœ¬ï¼Œä¸æ˜¯é€šè¿‡ manage.py å¯åŠ¨çš„
# å¦‚æœä¸åšè¿™ä¸€æ­¥ï¼Œä½  import Order çš„æ—¶å€™ä¼šæŠ¥é”™
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'careplan_backend.settings')
django.setup()

import redis
from django.conf import settings
from orders.models import Order, CarePlan
from orders.views import generate_care_plan

# ---- ç¬¬ 2 ä»¶äº‹ï¼šè¿æ¥ Redis ----
redis_client = redis.Redis.from_url(settings.REDIS_URL)


def process_order(order_id):
    """
    å¤„ç†å•ä¸ªè®¢å•ï¼šè°ƒ LLMï¼Œå­˜ CarePlanï¼Œæ›´æ–° status
    
    ä½ éœ€è¦åœ¨è¿™é‡Œåšï¼š
    1. ä»æ•°æ®åº“æŸ¥å‡º order
    2. æŠŠ status æ”¹æˆ 'processing'
    3. è°ƒç”¨ generate_care_plan(order)
    4. æˆåŠŸ â†’ åˆ›å»º CarePlanï¼Œstatus = 'completed'
       å¤±è´¥ â†’ status = 'failed'
    """
    # TODO: ä½ æ¥å†™
    try:
        order = Order.objects.get(id = order_id)
    except Order.DoesNotExist:
        print(f"Order {order_id} not found")
        return
    try:
        order.status = 'processing'
        order.save()
        content = generate_care_plan(order)
        if content is None:
            order.status = 'failed'
            order.save()
            return 
        CarePlan.objects.create(
            order = order,
            content = content,
        )
        order.status = 'completed'
        order.save()

    except Exception as e:
        print(f"Error processing order {order_id}: {e}")
        order.status = 'failed'
        order.save()
    


def run_worker():
    """
    æ— é™å¾ªç¯ï¼Œä» Redis æ‹‰ä»»åŠ¡
    
    ä½ éœ€è¦åœ¨è¿™é‡Œåšï¼š
    1. ç”¨ BRPOP ä» 'careplan_queue' å–ä»»åŠ¡
    2. æ‹¿åˆ° order_id
    3. è°ƒç”¨ process_order(order_id)
    """
    print("ğŸ”„ Worker started, waiting for tasks...")
    # TODO: ä½ æ¥å†™
    while True:
        result = redis_client.brpop('careplan_queue', timeout = 0)
        #è¿™é‡Œæœ‰brpopè€Œä¸æ˜¯rpopï¼Œå®ç°äº†Blocking I/Oï¼Œä¸­æ–­
        if result:
           order_id = int(result[1])
           process_order(order_id)
        else:
            print("No tasks in queue, waiting...")





# ---- ç¬¬ 3 ä»¶äº‹ï¼šå¯åŠ¨ worker ----
if __name__ == '__main__':
    run_worker()